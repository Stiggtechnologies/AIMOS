<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Filtering Verification</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .domain-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .domain-section h2 {
            margin-top: 0;
            color: #2563eb;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
        }
        .stat-card h3 {
            margin: 0 0 5px 0;
            font-size: 24px;
            color: #1e40af;
        }
        .stat-card p {
            margin: 0;
            font-size: 14px;
            color: #64748b;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        .error {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .success {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
            color: #166534;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>Domain Filtering Verification</h1>
    <p>Testing domain-specific filtering for the three starter packs</p>

    <div id="chronic-pain-section" class="domain-section">
        <h2>ðŸ©¹ Chronic Pain Starter Pack</h2>
        <div class="loading">Loading...</div>
    </div>

    <div id="acl-section" class="domain-section">
        <h2>ðŸ¦µ ACL / Return-to-Sport Starter Pack</h2>
        <div class="loading">Loading...</div>
    </div>

    <div id="neuro-section" class="domain-section">
        <h2>ðŸ§  Neuro Rehab Starter Pack</h2>
        <div class="loading">Loading...</div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = import.meta.env?.VITE_SUPABASE_URL || 'https://xtdewfoxawxqcnzjqkgx.supabase.co';
        const supabaseKey = import.meta.env?.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0ZGV3Zm94YXd4cWNuempxa2d4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MjcxMzEsImV4cCI6MjA1MTQwMzEzMX0.HCzgHl1LNDlJQn9G21WJ9Bb_ynP9jVtzEHbkMFQCBXE';
        const supabase = createClient(supabaseUrl, supabaseKey);

        async function testDomainFiltering(domain, sectionId) {
            const section = document.getElementById(sectionId);

            try {
                // Get sources for domain
                const { data: authorities } = await supabase
                    .from('evidence_authorities')
                    .select('authority_id')
                    .eq('domain', domain)
                    .eq('is_active', true);

                const authorityIds = authorities?.map(a => a.authority_id) || [];

                let sourcesCount = 0;
                if (authorityIds.length > 0) {
                    const { data: sources } = await supabase
                        .from('research_sources')
                        .select('id', { count: 'exact' })
                        .in('authority_id', authorityIds);
                    sourcesCount = sources?.length || 0;
                }

                // Get claims for domain (join through sources and authorities)
                const { data: claims } = await supabase
                    .from('evidence_claims')
                    .select(`
                        *,
                        research_sources!inner(
                            id,
                            evidence_authorities!inner(
                                domain
                            )
                        )
                    `)
                    .eq('research_sources.evidence_authorities.domain', domain)
                    .eq('status', 'approved');
                const claimsCount = claims?.length || 0;

                // Get rules for domain
                const { data: rules } = await supabase
                    .from('clinical_rules')
                    .select('rule_id', { count: 'exact' })
                    .eq('domain', domain)
                    .eq('is_active', true);
                const rulesCount = rules?.length || 0;

                // Get pathways for domain
                const { data: pathways } = await supabase
                    .from('care_pathway_templates')
                    .select('pathway_id', { count: 'exact' })
                    .eq('domain', domain)
                    .eq('is_active', true);
                const pathwaysCount = pathways?.length || 0;

                // Display results
                section.innerHTML = `
                    <h2>${section.querySelector('h2').innerHTML}</h2>
                    <div class="stats">
                        <div class="stat-card">
                            <h3>${sourcesCount}</h3>
                            <p>Research Sources</p>
                        </div>
                        <div class="stat-card">
                            <h3>${claimsCount}</h3>
                            <p>Evidence Claims</p>
                        </div>
                        <div class="stat-card">
                            <h3>${rulesCount}</h3>
                            <p>Clinical Rules</p>
                        </div>
                        <div class="stat-card">
                            <h3>${pathwaysCount}</h3>
                            <p>Care Pathways</p>
                        </div>
                    </div>
                    ${sourcesCount === 6 && claimsCount === 32 && rulesCount === 10 && pathwaysCount === 4
                        ? '<div class="success">âœ“ Domain filtering working correctly! Expected counts match.</div>'
                        : '<div class="error">âš  Unexpected counts. Expected: 6 sources, 32 claims, 10 rules, 4 pathways</div>'
                    }
                `;
            } catch (error) {
                console.error(`Error testing ${domain}:`, error);
                section.innerHTML = `
                    <h2>${section.querySelector('h2').innerHTML}</h2>
                    <div class="error">Error: ${error.message}</div>
                `;
            }
        }

        // Test all three domains
        testDomainFiltering('chronic_pain', 'chronic-pain-section');
        testDomainFiltering('acl', 'acl-section');
        testDomainFiltering('neuro', 'neuro-section');
    </script>
</body>
</html>
